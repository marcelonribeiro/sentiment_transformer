name: Deploy to Home Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Windows/WSL instance via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            # 1. Atualiza o código (usando caminho absoluto para evitar erros)
            echo ">>> [WSL] Pulling latest code..."
            wsl.exe -e bash -c "cd /home/marcelo/projects/sentiment_transformer && git checkout main && git pull origin main"

            # 2. Cria o arquivo .env (Usando 'printf' para segurança e evitando problemas de aspas/multilinha do Windows)
            echo ">>> [WSL] Creating production .env file..."
            wsl.exe -e bash -c "cd /home/marcelo/projects/sentiment_transformer && \
            printf 'DOMAIN_NAME=%s\n' '${{ secrets.DOMAIN_NAME }}' > .env && \
            printf 'POSTGRES_DB_APP=%s\n' '${{ secrets.POSTGRES_DB_APP }}' >> .env && \
            printf 'POSTGRES_USER_APP=%s\n' '${{ secrets.POSTGRES_USER_APP }}' >> .env && \
            printf 'POSTGRES_PASSWORD_APP=%s\n' '${{ secrets.POSTGRES_PASSWORD_APP }}' >> .env && \
            printf 'POSTGRES_HOST_APP=postgres-app\n' >> .env && \
            printf 'POSTGRES_PORT_APP=5432\n' >> .env && \
            printf 'APP_DATABASE_URL=%s\n' '${{ secrets.APP_DATABASE_URL }}' >> .env && \
            printf 'MLFLOW_TRACKING_USERNAME=%s\n' '${{ secrets.MLFLOW_TRACKING_USERNAME }}' >> .env && \
            printf 'MLFLOW_TRACKING_PASSWORD=%s\n' '${{ secrets.MLFLOW_TRACKING_PASSWORD }}' >> .env && \
            printf 'MLFLOW_FLASK_SERVER_SECRET_KEY=%s\n' '${{ secrets.MLFLOW_FLASK_SERVER_SECRET_KEY }}' >> .env && \
            printf 'MLFLOW_TRACKING_URI=%s\n' '${{ secrets.MLFLOW_TRACKING_URI }}' >> .env && \
            printf 'API_BASE_URL=%s\n' '${{ secrets.API_BASE_URL }}' >> .env && \
            printf 'AIRFLOW__WEBSERVER__BASE_URL=%s\n' '${{ secrets.AIRFLOW__WEBSERVER__BASE_URL }}' >> .env && \
            printf 'AIRFLOW__CORE__EXECUTION_API_SERVER_URL=http://127.0.0.1:8080/airflow/execution\n' >> .env && \
            printf 'AIRFLOW__WEBSERVER__SECRET_KEY=%s\n' '${{ secrets.AIRFLOW_API_SECRET_KEY }}' >> .env && \
            printf 'AIRFLOW_CONN_APP_POSTGRES_CONN=%s\n' '${{ secrets.AIRFLOW_CONN_APP_POSTGRES_CONN }}' >> .env && \
            printf 'DVC_S3_URL=%s\n' '${{ secrets.DVC_S3_URL }}' >> .env && \
            printf 'AWS_ACCESS_KEY_ID=%s\n' '${{ secrets.AWS_ACCESS_KEY_ID }}' >> .env && \
            printf 'AWS_SECRET_ACCESS_KEY=%s\n' '${{ secrets.AWS_SECRET_ACCESS_KEY }}' >> .env && \
            printf 'AWS_DEFAULT_REGION=%s\n' '${{ secrets.AWS_DEFAULT_REGION }}' >> .env && \
            printf 'STRATEGIA_INVEST_API_USERNAME=%s\n' '${{ secrets.STRATEGIA_INVEST_API_USERNAME }}' >> .env && \
            printf 'STRATEGIA_INVEST_API_PASSWORD=%s\n' '${{ secrets.STRATEGIA_INVEST_API_PASSWORD }}' >> .env && \
            printf 'STRATEGIA_INVEST_API_BASE_URL=%s\n' '${{ secrets.STRATEGIA_INVEST_API_BASE_URL }}' >> .env && \
            printf 'AIRFLOW__WEBSERVER__WTF_CSRF_TRUSTED_ORIGINS=http://localhost:8080,http://127.0.0.1:8080\n' >> .env"

            # 3. Para os containers antigos
            echo ">>> [WSL] Stopping old containers..."
            wsl.exe -e bash -c "cd /home/marcelo/projects/sentiment_transformer && docker compose down --remove-orphans"

            # 4. Inicia o deploy
            echo ">>> [WSL] Building and starting new containers..."
            wsl.exe -e bash -c "cd /home/marcelo/projects/sentiment_transformer && chmod +x ./start.sh && ./start.sh --build --force-recreate"

            echo ">>> Deployment finished!"